'use server';

import { generateOTP } from '@/lib/otp-Generator';
import { sendOTPTemplate, sendOTPTextMessage, generateWhatsAppGuidanceURL } from '@/lib/whatsapp-template-api';
import { getWhatsAppConfig } from '@/lib/whatsapp/config';
import db from '@/lib/prisma';
import { auth } from '@/auth';

// Rate limiting helper
const rateLimitStore = new Map<string, { count: number; resetTime: number }>();

const checkRateLimit = (userId: string): boolean => {
  const now = Date.now();
  const key = `otp_${userId}`;
  const limit = rateLimitStore.get(key);

  if (!limit || now > limit.resetTime) {
    rateLimitStore.set(key, { count: 1, resetTime: now + 60 * 60 * 1000 });
    return true;
  }

  if (limit.count >= 5) {
    return false;
  }

  limit.count++;
  return true;
};

// OTP via WhatsApp handler - Session-based
export const otpViaWhatsApp = async () => {
  try {
    // Get user from session
    const session = await auth();
    if (!session?.user?.id) {
      return {
        success: false,
        message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'
      };
    }

    const userId = session.user.id;
    const userPhone = session.user.phone;

    if (!userPhone) {
      return {
        success: false,
        message: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨'
      };
    }

    // Check rate limiting
    if (!checkRateLimit(userId)) {
      return {
        success: false,
        message: 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹'
      };
    }

    const { token, expires } = generateOTP();

    // Update user with OTP using user ID
    await db.user.update({
      where: { id: userId },
      data: {
        otpCode: token,
        isOtp: false
      }
    });

    // Only return fake OTP if WhatsApp token is completely missing
    if (!process.env.WHATSAPP_PERMANENT_TOKEN) {
      console.log('âš ï¸ WhatsApp token missing, returning fake OTP');
      return {
        success: true,
        message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (ÙˆÙ‡Ù…ÙŠ) - WhatsApp ØºÙŠØ± Ù…ÙØ¹Ø¯',
        token,
        expires,
        phoneNumber: userPhone,
        isFake: true
      };
    }

    // Use text message as primary method (works reliably)
    // Code delivery setup templates have complex button requirements that are causing API errors
    let whatsappResult;
    let attemptLog = [];

    try {
      // Primary method: Use text message (works for users who messaged business)
      console.log(`ğŸ” Attempting text message for user ${userId} (${userPhone})`);
      whatsappResult = await sendOTPTextMessage(userPhone, token);
      attemptLog.push(`Text message: ${whatsappResult.success ? 'SUCCESS' : 'FAILED - ' + whatsappResult.error}`);

      if (!whatsappResult.success) {
        console.log('Text message failed, trying template:', whatsappResult.error);
        // Fallback: Use template (may work for new users, but has button structure issues)
        console.log(`ğŸ” Attempting template message for user ${userId} (${userPhone})`);
        whatsappResult = await sendOTPTemplate(userPhone, token);
        attemptLog.push(`Template message: ${whatsappResult.success ? 'SUCCESS' : 'FAILED - ' + whatsappResult.error}`);
      }
    } catch (error) {
      console.error('WhatsApp API error:', error);
      whatsappResult = { success: false, error: 'WhatsApp API error' };
      attemptLog.push(`API error: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }

    // Log all attempts for debugging
    console.log(`ğŸ“Š OTP attempts for user ${userId}:`, attemptLog.join(' | '));

    if (!whatsappResult.success) {
      // If WhatsApp fails, provide guidance with clickable WhatsApp link
      console.error('WhatsApp OTP failed:', whatsappResult.error);
      const whatsappGuidanceURL = generateWhatsAppGuidanceURL(userPhone);

      return {
        success: true,
        message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (ÙˆÙ‡Ù…ÙŠ) - Ø®Ø·Ø£ ÙÙŠ WhatsApp',
        token,
        expires,
        phoneNumber: userPhone,
        isFake: true,
        whatsappError: whatsappResult.error,
        whatsappGuidanceURL: whatsappGuidanceURL,
        guidanceMessage: 'Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø±Ù‚Ù… WhatsApp Ø£ÙˆÙ„Ø§Ù‹'
      };
    }

    return {
      success: true,
      message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± WhatsApp',
      expires,
      phoneNumber: userPhone,
      isFake: false
    };

  } catch (error) {
    console.error('Error in otpViaWhatsApp:', error);
    return {
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'
    };
  }
};

// Verify OTP - Session-based
export const verifyTheUser = async (code: string) => {
  try {
    // Get user from session
    const session = await auth();
    if (!session?.user?.id) {
      return {
        success: false,
        message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'
      };
    }

    const userId = session.user.id;

    // Get user with OTP data
    const user = await db.user.findUnique({
      where: { id: userId },
      select: {
        id: true,
        otpCode: true,
        isOtp: true,
        phone: true
      }
    });

    if (!user) {
      return {
        success: false,
        message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'
      };
    }

    if (!user.otpCode) {
      return {
        success: false,
        message: 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯'
      };
    }

    if (user.otpCode !== code) {
      return {
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­'
      };
    }

    // Update user status using user ID
    await db.user.update({
      where: { id: userId },
      data: {
        isOtp: true,
        isActive: true,
        otpCode: null // Clear OTP after successful verification
      }
    });

    return {
      success: true,
      message: 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­'
    };

  } catch (error) {
    console.error('Error in verifyTheUser:', error);
    return {
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'
    };
  }
};

// Resend OTP with cooldown - Session-based
export const resendOTP = async () => {
  try {
    // Get user from session
    const session = await auth();
    if (!session?.user?.id) {
      return {
        success: false,
        message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'
      };
    }

    const userId = session.user.id;

    // Check cooldown
    const cooldownKey = `cooldown_${userId}`;
    const cooldown = rateLimitStore.get(cooldownKey);
    const now = Date.now();

    if (cooldown && now < cooldown.resetTime) {
      const remainingSeconds = Math.ceil((cooldown.resetTime - now) / 1000);
      return {
        success: false,
        message: `ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${remainingSeconds} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„`
      };
    }

    // Set cooldown
    rateLimitStore.set(cooldownKey, {
      count: 1,
      resetTime: now + 2 * 60 * 1000 // 2 minutes cooldown
    });

    // Send new OTP
    return await otpViaWhatsApp();

  } catch (error) {
    console.error('Error in resendOTP:', error);
    return {
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'
    };
  }
};

// Test function for the Arabic "confirm" template shown in the image
export const testArabicConfirmTemplate = async (phoneNumber: string) => {
  try {
    const accessToken = process.env.WHATSAPP_PERMANENT_TOKEN;
    const phoneNumberId = process.env.WHATSAPP_PHONE_NUMBER_ID;
    const apiVersion = process.env.WHATSAPP_API_VERSION || 'v23.0';

    if (!accessToken || !phoneNumberId) {
      return { success: false, error: 'Server configuration error' };
    }

    // Convert phone number to international format
    const cleaned = phoneNumber.replace(/\D/g, '');
    let internationalPhone = phoneNumber;

    if (cleaned.startsWith('05') && cleaned.length === 10) {
      const numberWithoutZero = cleaned.substring(1);
      internationalPhone = `+966${numberWithoutZero}`;
    } else if (phoneNumber.startsWith('+966')) {
      internationalPhone = phoneNumber;
    }

    console.log(`ğŸ“± Testing Arabic confirm template for: ${phoneNumber} â†’ ${internationalPhone}`);

    const endpoint = `https://graph.facebook.com/${apiVersion}/${phoneNumberId}/messages`;

    // Test the Arabic "confirm" template from the image
    const testOTP = '1234'; // Test OTP
    const requestBody = {
      messaging_product: 'whatsapp',
      to: internationalPhone,
      type: 'template',
      template: {
        name: 'confirm',
        language: {
          code: 'ar'
        },
        components: [
          {
            type: 'body',
            parameters: [
              {
                type: 'text',
                text: testOTP
              }
            ]
          }
        ]
      }
    };

    console.log(`ğŸ” Testing Arabic confirm template:`, JSON.stringify(requestBody, null, 2));

    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify(requestBody),
    });

    const data = await response.json();
    console.log(`ğŸ“¡ Arabic confirm template test response (${response.status}):`, JSON.stringify(data, null, 2));

    if (response.ok) {
      console.log(`âœ… Arabic confirm template test SUCCESS!`);
      return {
        success: true,
        data,
        message: 'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­',
        templateName: 'confirm',
        language: 'ar',
        testOTP: testOTP
      };
    } else {
      console.log(`âŒ Arabic confirm template test FAILED:`, data.error?.message);
      return {
        success: false,
        error: data.error?.message || 'Template test failed',
        templateName: 'confirm',
        language: 'ar',
        fullError: data
      };
    }

  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';
    console.error('Error testing Arabic confirm template:', error);
    return {
      success: false,
      error: errorMessage,
      templateName: 'confirm',
      language: 'ar'
    };
  }
}; 